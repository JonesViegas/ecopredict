{% extends "base.html" %}

{% block title %}Relat√≥rios - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-chart-bar"></i> Relat√≥rios e An√°lises</h4>
                </div>
                <div class="card-body">
                    <p class="lead">Gere relat√≥rios detalhados sobre a qualidade do ar na regi√£o amaz√¥nica.</p>
                    
                    <!-- Gerar Relat√≥rios -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-file-pdf"></i> Gerar Relat√≥rio</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card text-center report-card" onclick="generateReport('daily')">
                                        <div class="card-body">
                                            <i class="fas fa-calendar-day fa-3x text-info mb-3"></i>
                                            <h6>Relat√≥rio Di√°rio</h6>
                                            <small class="text-muted">√öltimas 24 horas</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center report-card" onclick="generateReport('weekly')">
                                        <div class="card-body">
                                            <i class="fas fa-calendar-week fa-3x text-warning mb-3"></i>
                                            <h6>Relat√≥rio Semanal</h6>
                                            <small class="text-muted">√öltima semana</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center report-card" onclick="generateReport('monthly')">
                                        <div class="card-body">
                                            <i class="fas fa-calendar-alt fa-3x text-danger mb-3"></i>
                                            <h6>Relat√≥rio Mensal</h6>
                                            <small class="text-muted">√öltimos 30 dias</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="report-status" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Resultados do Relat√≥rio -->
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-chart-line"></i> Resultados do Relat√≥rio</h5>
                        </div>
                        <div class="card-body">
                            <div id="report-results">
                                <p class="text-muted text-center">Selecione um tipo de relat√≥rio para gerar a an√°lise</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .report-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .alert-box {
        border-left: 4px solid;
        padding: 10px 15px;
        margin: 10px 0;
    }
    .alert-warning { border-color: #ffc107; background-color: #fffbf0; }
    .alert-danger { border-color: #dc3545; background-color: #fdf2f2; }
</style>

<script>
function generateReport(type) {
    const statusDiv = document.getElementById('report-status');
    const resultsDiv = document.getElementById('report-results');
    
    statusDiv.innerHTML = '<div class="alert alert-info">Gerando relat√≥rio... Aguarde.</div>';
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div><p>Processando dados...</p></div>';
    
    fetch(`/api/generate-report?type=${type}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.innerHTML = `<div class="alert alert-success">Relat√≥rio ${type} gerado com sucesso!</div>`;
                displayReportResults(data.report);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">Erro: ${data.message}</div>`;
                resultsDiv.innerHTML = '<p class="text-muted text-center">Erro ao gerar relat√≥rio</p>';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error}</div>`;
            resultsDiv.innerHTML = '<p class="text-muted text-center">Erro de conex√£o</p>';
        });
}

function displayReportResults(report) {
    const resultsDiv = document.getElementById('report-results');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6>üìä Estat√≠sticas Gerais</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Per√≠odo:</strong> ${report.period}</p>
                        <p><strong>Data inicial:</strong> ${new Date(report.start_date).toLocaleDateString('pt-BR')}</p>
                        <p><strong>Data final:</strong> ${new Date(report.end_date).toLocaleDateString('pt-BR')}</p>
                        <p><strong>Total de registros:</strong> ${report.total_records}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6>üå°Ô∏è M√©tricas de Qualidade do Ar</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Par√¢metro</th>
                                    <th>M√©dia</th>
                                    <th>M√°ximo</th>
                                    <th>M√≠nimo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>AQI</td>
                                    <td>${report.stats.aqi.mean.toFixed(1)}</td>
                                    <td>${report.stats.aqi.max.toFixed(1)}</td>
                                    <td>${report.stats.aqi.min.toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>PM2.5</td>
                                    <td>${report.stats.pm25.mean.toFixed(1)} ¬µg/m¬≥</td>
                                    <td>${report.stats.pm25.max.toFixed(1)} ¬µg/m¬≥</td>
                                    <td>${report.stats.pm25.min.toFixed(1)} ¬µg/m¬≥</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Adicionar alertas se existirem
    if (report.alerts && report.alerts.length > 0) {
        html += `<div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6>‚ö†Ô∏è Alertas e Recomenda√ß√µes</h6>
                    </div>
                    <div class="card-body">`;
        
        report.alerts.forEach(alert => {
            const alertClass = alert.type === 'warning' ? 'alert-warning' : 'alert-danger';
            html += `
                <div class="alert-box ${alertClass}">
                    <strong>${alert.type === 'warning' ? '‚ö†Ô∏è Aviso' : 'üö® Alerta Cr√≠tico'}:</strong> 
                    ${alert.message}
                    ${alert.locations ? `<br><small><strong>Localiza√ß√µes:</strong> ${alert.locations.join(', ')}</small>` : ''}
                </div>
            `;
        });
        
        html += `</div></div></div></div>`;
    }
    
    // Adicionar recomenda√ß√µes
    html += `
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6>üí° Recomenda√ß√µes</h6>
                    </div>
                    <div class="card-body">
                        ${generateRecommendations(report)}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}

function generateRecommendations(report) {
    const aqiMean = report.stats.aqi.mean;
    const pm25Mean = report.stats.pm25.mean;
    
    let recommendations = [];
    
    if (aqiMean > 100) {
        recommendations.push("üö® N√≠veis de polui√ß√£o elevados. Recomenda-se evitar atividades f√≠sicas ao ar livre.");
    }
    
    if (pm25Mean > 35) {
        recommendations.push("üò∑ Altos n√≠veis de PM2.5. Considere usar m√°scaras em ambientes externos.");
    }
    
    if (aqiMean < 50) {
        recommendations.push("‚úÖ Qualidade do ar boa. Condi√ß√µes ideais para atividades externas.");
    }
    
    if (report.alerts && report.alerts.length > 0) {
        recommendations.push("üì¢ Aten√ß√£o aos alertas emitidos. Monitore as localiza√ß√µes cr√≠ticas.");
    }
    
    recommendations.push("üå≥ Mantenha o monitoramento cont√≠nuo para identificar tend√™ncias.");
    recommendations.push("üîç Considere implementar medidas de mitiga√ß√£o nas √°reas mais cr√≠ticas.");
    
    return recommendations.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('');
}

// Adicionar efeitos de hover nos cards
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.report-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}