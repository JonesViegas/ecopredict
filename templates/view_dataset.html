{% extends "base.html" %}

{% block title %}{{ dataset.name }} - EcoPredict{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-eye"></i> {{ dataset.name }}</h4>
                    <div>
                        <a href="{{ url_for('data.datasets_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                        <a href="{{ url_for('analysis.analyze_dataset', dataset_id=dataset.id) }}" 
                           class="btn btn-success">
                            <i class="fas fa-brain"></i> Analisar com IA
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Informações do Dataset</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th>Descrição:</th>
                                    <td>{{ dataset.description or 'Sem descrição' }}</td>
                                </tr>
                                <tr>
                                    <th>Criado em:</th>
                                    <td>{{ dataset.created_at.strftime('%d/%m/%Y às %H:%M') }}</td>
                                </tr>
                                <tr>
                                    <th>Arquivo:</th>
                                    <td>{{ dataset.filename }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Estatísticas</h6>
                            <div id="dataset-stats">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Carregando estatísticas...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dados em Tabela -->
                    <h6>Dados do Dataset</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="data-table">
                            <thead>
                                <tr>
                                    <th>Localização</th>
                                    <th>Latitude</th>
                                    <th>Longitude</th>
                                    <th>PM2.5</th>
                                    <th>PM10</th>
                                    <th>AQI</th>
                                    <th>Temperatura</th>
                                    <th>Umidade</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Visualização Gráfica -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Distribuição de AQI</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="aqiChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Poluentes Principais</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="pollutantsChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let datasetId = {{ dataset.id }};

// Carregar dados do dataset
fetch(`/api/dataset/${datasetId}`)
    .then(response => response.json())
    .then(data => {
        displayDatasetStats(data);
        displayDataTable(data.records);
        createCharts(data.records);
    })
    .catch(error => {
        console.error('Erro ao carregar dados:', error);
    });

function displayDatasetStats(data) {
    const statsDiv = document.getElementById('dataset-stats');
    const records = data.records;
    
    if (records.length === 0) {
        statsDiv.innerHTML = '<div class="alert alert-warning">Nenhum dado encontrado</div>';
        return;
    }

    // Calcular estatísticas
    const aqiValues = records.filter(r => r.aqi).map(r => r.aqi);
    const pm25Values = records.filter(r => r.pm25).map(r => r.pm25);
    
    const stats = {
        totalRecords: records.length,
        avgAQI: aqiValues.length ? (aqiValues.reduce((a, b) => a + b) / aqiValues.length).toFixed(1) : 'N/A',
        maxPM25: pm25Values.length ? Math.max(...pm25Values).toFixed(1) : 'N/A',
        locations: new Set(records.map(r => r.location)).size
    };

    statsDiv.innerHTML = `
        <div class="row text-center">
            <div class="col-4">
                <h4 class="text-primary">${stats.totalRecords}</h4>
                <small>Registros</small>
            </div>
            <div class="col-4">
                <h4 class="text-success">${stats.avgAQI}</h4>
                <small>AQI Médio</small>
            </div>
            <div class="col-4">
                <h4 class="text-warning">${stats.locations}</h4>
                <small>Localizações</small>
            </div>
        </div>
    `;
}

function displayDataTable(records) {
    const tbody = document.getElementById('data-table-body');
    
    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum dado disponível</td></tr>';
        return;
    }

    tbody.innerHTML = records.slice(0, 50).map(record => `
        <tr>
            <td>${record.location}</td>
            <td>${record.latitude.toFixed(4)}</td>
            <td>${record.longitude.toFixed(4)}</td>
            <td>${record.pm25 ? record.pm25.toFixed(1) : 'N/A'}</td>
            <td>${record.pm10 ? record.pm10.toFixed(1) : 'N/A'}</td>
            <td>
                <span class="badge ${getAQIBadgeClass(record.aqi)}">
                    ${record.aqi ? record.aqi.toFixed(1) : 'N/A'}
                </span>
            </td>
            <td>${record.temperature ? record.temperature.toFixed(1) + '°C' : 'N/A'}</td>
            <td>${record.humidity ? record.humidity.toFixed(1) + '%' : 'N/A'}</td>
        </tr>
    `).join('');

    // Mostrar mensagem se houver mais registros
    if (records.length > 50) {
        tbody.innerHTML += `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    ... e mais ${records.length - 50} registros
                </td>
            </tr>
        `;
    }
}

function getAQIBadgeClass(aqi) {
    if (!aqi) return 'bg-secondary';
    if (aqi <= 50) return 'bg-success';
    if (aqi <= 100) return 'bg-warning';
    if (aqi <= 150) return 'bg-orange';
    return 'bg-danger';
}

function createCharts(records) {
    // Gráfico de distribuição de AQI
    const aqiCtx = document.getElementById('aqiChart').getContext('2d');
    const aqiRanges = ['0-50', '51-100', '101-150', '151-200', '201+'];
    const aqiCounts = [0, 0, 0, 0, 0];
    
    records.forEach(record => {
        if (record.aqi) {
            if (record.aqi <= 50) aqiCounts[0]++;
            else if (record.aqi <= 100) aqiCounts[1]++;
            else if (record.aqi <= 150) aqiCounts[2]++;
            else if (record.aqi <= 200) aqiCounts[3]++;
            else aqiCounts[4]++;
        }
    });

    new Chart(aqiCtx, {
        type: 'bar',
        data: {
            labels: aqiRanges,
            datasets: [{
                label: 'Registros por AQI',
                data: aqiCounts,
                backgroundColor: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Gráfico de poluentes
    const pollutantsCtx = document.getElementById('pollutantsChart').getContext('2d');
    const pollutants = ['PM2.5', 'PM10', 'NO₂', 'O₃'];
    const pollutantCounts = pollutants.map(p => 
        records.filter(r => {
            if (p === 'PM2.5') return r.pm25;
            if (p === 'PM10') return r.pm10;
            if (p === 'NO₂') return r.no2;
            if (p === 'O₃') return r.o3;
            return false;
        }).length
    );

    new Chart(pollutantsCtx, {
        type: 'doughnut',
        data: {
            labels: pollutants,
            datasets: [{
                data: pollutantCounts,
                backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}
</script>

<style>
.bg-orange { background-color: #ff7e00 !important; }
</style>
{% endblock %}