{% extends "base.html" %}

{% block title %}Análise - EcoPredict{% endblock %}

{% block extra_css %}
<style>
    .model-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .model-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .cluster-badge {
        font-size: 0.8em;
        padding: 4px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-brain"></i> Análise com Machine Learning</h4>
                </div>
                <div class="card-body">
                    <p class="lead">Utilize modelos de IA para prever e analisar a qualidade do ar na Amazônia.</p>
                    
                    <!-- Treinamento de Modelos -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-robot"></i> Treinamento de Modelos</h5>
                        </div>
                        <div class="card-body">
                            <p>Treine modelos de machine learning com seus dados para fazer previsões precisas.</p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card model-card text-center" onclick="trainModel('random_forest')">
                                        <div class="card-body">
                                            <i class="fas fa-tree fa-3x text-success mb-3"></i>
                                            <h6>Random Forest</h6>
                                            <small class="text-muted">Alta precisão para previsões</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card model-card text-center" onclick="trainModel('linear_regression')">
                                        <div class="card-body">
                                            <i class="fas fa-chart-line fa-3x text-info mb-3"></i>
                                            <h6>Regressão Linear</h6>
                                            <small class="text-muted">Rápido e interpretável</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card model-card text-center" onclick="trainModel('kmeans')">
                                        <div class="card-body">
                                            <i class="fas fa-object-group fa-3x text-warning mb-3"></i>
                                            <h6>K-Means</h6>
                                            <small class="text-muted">Agrupamento de regiões</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="training-status" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Previsões -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-crystal-ball"></i> Fazer Previsões</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <form id="prediction-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">PM2.5 (µg/m³)</label>
                                                <input type="number" class="form-control" name="pm25" value="15" step="0.1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">PM10 (µg/m³)</label>
                                                <input type="number" class="form-control" name="pm10" value="25" step="0.1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">NO₂ (ppm)</label>
                                                <input type="number" class="form-control" name="no2" value="0.02" step="0.001">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">O₃ (ppm)</label>
                                                <input type="number" class="form-control" name="o3" value="0.05" step="0.001">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">CO₂ (ppm)</label>
                                                <input type="number" class="form-control" name="co2" value="400" step="1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Temperatura (°C)</label>
                                                <input type="number" class="form-control" name="temperature" value="28" step="0.1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Umidade (%)</label>
                                                <input type="number" class="form-control" name="humidity" value="78" step="0.1">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Modelo</label>
                                                <select class="form-select" name="model_type">
                                                    <option value="random_forest">Random Forest</option>
                                                    <option value="linear_regression">Regressão Linear</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-bolt"></i> Fazer Previsão
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <div id="prediction-result" class="text-center mt-4">
                                        <p class="text-muted">Preencha os valores e clique em "Fazer Previsão"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Análise de Clusters -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-map-marked-alt"></i> Análise de Clusters</h5>
                        </div>
                        <div class="card-body">
                            <p>Identifique padrões espaciais na qualidade do ar através de agrupamento.</p>
                            <button class="btn btn-info mb-3" onclick="performClusterAnalysis()">
                                <i class="fas fa-project-diagram"></i> Executar Análise de Clusters
                            </button>
                            <div id="cluster-results"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function trainModel(modelType) {
    const statusDiv = document.getElementById('training-status');
    statusDiv.innerHTML = '<div class="alert alert-info">Treinando modelo... Isso pode levar alguns minutos.</div>';
    
    fetch('/analysis/train-models', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let metricsHtml = '<div class="alert alert-success"><h6>Modelos treinados com sucesso!</h6>';
            
            if (data.metrics) {
                metricsHtml += '<div class="row mt-3">';
                for (const [model, metrics] of Object.entries(data.metrics)) {
                    metricsHtml += `
                        <div class="col-md-6">
                            <h6>${model === 'random_forest' ? 'Random Forest' : 'Regressão Linear'}</h6>
                            <small>MSE: ${metrics.mse.toFixed(4)} | R²: ${metrics.r2.toFixed(4)}</small>
                        </div>
                    `;
                }
                metricsHtml += '</div>';
            }
            
            metricsHtml += '</div>';
            statusDiv.innerHTML = metricsHtml;
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Erro: ${data.message}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error}</div>`;
    });
}

document.getElementById('prediction-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
        // Converter para número quando possível
        data[key] = isNaN(value) ? value : parseFloat(value);
    });
    
    const resultDiv = document.getElementById('prediction-result');
    resultDiv.innerHTML = '<div class="spinner-border text-success" role="status"></div><p>Processando...</p>';
    
    fetch('/analysis/predict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>Previsão Concluída</h6>
                    <p class="mb-1">Modelo: ${data.model_used === 'random_forest' ? 'Random Forest' : 'Regressão Linear'}</p>
                    <h4>Pressão: ${data.prediction.toFixed(2)} hPa</h4>
                    <small class="text-muted">Baseado nos parâmetros fornecidos</small>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">Erro: ${data.message}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error}</div>`;
    });
});

function performClusterAnalysis() {
    const resultsDiv = document.getElementById('cluster-results');
    resultsDiv.innerHTML = '<div class="alert alert-info">Executando análise de clusters...</div>';
    
    fetch('/analysis/cluster-analysis')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let clustersHtml = '<div class="alert alert-success"><h6>Análise de Clusters Concluída</h6>';
                clustersHtml += '<p>Regiões agrupadas por padrões de poluição:</p>';
                
                // Agrupar por cluster
                const clusters = {};
                data.clusters.forEach(item => {
                    if (!clusters[item.cluster]) {
                        clusters[item.cluster] = [];
                    }
                    clusters[item.cluster].push(item);
                });
                
                for (const [clusterId, locations] of Object.entries(clusters)) {
                    const levels = ['Baixo', 'Moderado', 'Alto', 'Muito Alto'];
                    const colors = ['success', 'warning', 'danger', 'dark'];
                    
                    clustersHtml += `
                        <div class="card mt-3">
                            <div class="card-header">
                                <span class="badge bg-${colors[clusterId]}">Cluster ${parseInt(clusterId)+1} - ${levels[clusterId]}</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    ${locations.slice(0, 5).map(loc => `
                                        <div class="col-md-6 mb-2">
                                            <strong>${loc.location}</strong><br>
                                            <small class="text-muted">AQI: ${loc.aqi.toFixed(1)} | Lat: ${loc.lat.toFixed(4)}, Lng: ${loc.lng.toFixed(4)}</small>
                                        </div>
                                    `).join('')}
                                </div>
                                ${locations.length > 5 ? `<p class="mt-2"><small>... e mais ${locations.length - 5} localizações</small></p>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                clustersHtml += '</div>';
                resultsDiv.innerHTML = clustersHtml;
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Erro: ${data.message}</div>`;
            }
        })
        .catch(error => {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error}</div>`;
        });
}
</script>
{% endblock %}